name: Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.x

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase
        run: supabase start

      - name: Get Supabase credentials
        id: supabase-creds
        run: |
          SUPABASE_STATUS=$(supabase status -o env)
          SUPABASE_TEST_URL=$(echo "$SUPABASE_STATUS" | awk -F '=' '/API_URL/ {gsub(/"/, "", $2); print $2}')
          SUPABASE_TEST_SERVICE_ROLE_KEY=$(echo "$SUPABASE_STATUS" | awk -F '=' '/SERVICE_ROLE_KEY/ {gsub(/"/, "", $2); print $2}')

          echo "SUPABASE_TEST_URL=${SUPABASE_TEST_URL}" >> "$GITHUB_ENV"
          echo "SUPABASE_TEST_SERVICE_ROLE_KEY=${SUPABASE_TEST_SERVICE_ROLE_KEY}" >> "$GITHUB_ENV"

      - name: Apply Supabase migrations
        run: supabase migration up --local --yes

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: |
          dotnet build Supabase.FSharp/Supabase.FSharp.fsproj --configuration Release --no-restore
          dotnet build Supabase.FSharp.Tests/Supabase.FSharp.Tests.fsproj --configuration Release --no-restore

      - name: Test
        run: dotnet test Supabase.FSharp.Tests/Supabase.FSharp.Tests.fsproj --configuration Release --no-restore
        env:
          SUPABASE_TEST_URL: ${{ env.SUPABASE_TEST_URL }}
          SUPABASE_TEST_SERVICE_ROLE_KEY: ${{ env.SUPABASE_TEST_SERVICE_ROLE_KEY }}
